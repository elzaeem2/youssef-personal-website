// Test CMS update workflow with a simple change
const fs = require('fs');
const https = require('https');

console.log('๐งช ุงุฎุชุจุงุฑ ุชุญุฏูุซ CMS ูุน ุชุบููุฑ ุจุณูุท...\n');
console.log('=' .repeat(50) + '\n');

// Create a simple test update
function createTestUpdate() {
    console.log('๐ ุฅูุดุงุก ุชุญุฏูุซ ุชุฌุฑูุจู:\n');
    
    // Create a simple test file that CMS can modify
    const testContent = {
        title: "ุงุฎุชุจุงุฑ ุชุญุฏูุซ CMS",
        description: "ูุฐุง ููู ุงุฎุชุจุงุฑ ูุชุฌุฑุจุฉ ุชุญุฏูุซุงุช CMS",
        phone: "123-456-7890",
        email: "test@example.com",
        last_updated: new Date().toISOString(),
        test_number: Math.floor(Math.random() * 1000)
    };
    
    // Save to content/settings/test.yml
    const yamlContent = `# ููู ุงุฎุชุจุงุฑ ูุชุญุฏูุซุงุช CMS
title: "${testContent.title}"
description: "${testContent.description}"
contact:
  phone: "${testContent.phone}"
  email: "${testContent.email}"
last_updated: "${testContent.last_updated}"
test_number: ${testContent.test_number}

# ููููู ุชุญุฏูุซ ูุฐู ุงูููู ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ
# ูุงุฎุชุจุงุฑ ุนูู ูุธุงู CMS
`;
    
    try {
        fs.writeFileSync('content/settings/test.yml', yamlContent);
        console.log('   โ ุชู ุฅูุดุงุก ููู ุงูุงุฎุชุจุงุฑ: content/settings/test.yml');
        console.log(`   ๐ ุฑูู ุงููุงุชู ุงูุญุงูู: ${testContent.phone}`);
        console.log(`   ๐ข ุฑูู ุงูุงุฎุชุจุงุฑ: ${testContent.test_number}`);
        return testContent;
    } catch (error) {
        console.log(`   โ ุฎุทุฃ ูู ุฅูุดุงุก ููู ุงูุงุฎุชุจุงุฑ: ${error.message}`);
        return null;
    }
}

// Add test collection to CMS config
function addTestCollectionToConfig() {
    console.log('\nโ๏ธ ุฅุถุงูุฉ ูุฌููุนุฉ ุงูุงุฎุชุจุงุฑ ุฅูู ุฅุนุฏุงุฏุงุช CMS:\n');
    
    try {
        let config = fs.readFileSync('admin/config.yml', 'utf8');
        
        // Check if test collection already exists
        if (config.includes('name: "test"')) {
            console.log('   โ ูุฌููุนุฉ ุงูุงุฎุชุจุงุฑ ููุฌูุฏุฉ ุจุงููุนู');
            return true;
        }
        
        // Add test collection at the end
        const testCollection = `
  # ===== ุงุฎุชุจุงุฑ CMS =====
  - name: "test"
    label: "๐งช ุงุฎุชุจุงุฑ ุงููุธุงู"
    folder: "content/settings"
    create: false
    delete: false
    slug: "test"
    fields:
      - { label: "ุงูุนููุงู", name: "title", widget: "string" }
      - { label: "ุงููุตู", name: "description", widget: "text" }
      - label: "ูุนูููุงุช ุงูุงุชุตุงู"
        name: "contact"
        widget: "object"
        fields:
          - { label: "ุฑูู ุงููุงุชู", name: "phone", widget: "string", hint: "ุบูุฑ ูุฐุง ุงูุฑูู ูุงุฎุชุจุงุฑ CMS" }
          - { label: "ุงูุจุฑูุฏ ุงูุฅููุชุฑููู", name: "email", widget: "string" }
      - { label: "ุขุฎุฑ ุชุญุฏูุซ", name: "last_updated", widget: "datetime" }
      - { label: "ุฑูู ุงูุงุฎุชุจุงุฑ", name: "test_number", widget: "number", hint: "ุบูุฑ ูุฐุง ุงูุฑูู ูุงุฎุชุจุงุฑ ุงูุชุญุฏูุซ" }
`;
        
        config += testCollection;
        
        fs.writeFileSync('admin/config.yml', config);
        console.log('   โ ุชู ุฅุถุงูุฉ ูุฌููุนุฉ ุงูุงุฎุชุจุงุฑ ุฅูู ุฅุนุฏุงุฏุงุช CMS');
        return true;
    } catch (error) {
        console.log(`   โ ุฎุทุฃ ูู ุชุญุฏูุซ ุฅุนุฏุงุฏุงุช CMS: ${error.message}`);
        return false;
    }
}

// Monitor GitHub for new commits
function monitorGitHubCommits() {
    return new Promise((resolve) => {
        console.log('\n๐ ูุฑุงูุจุฉ GitHub ููุชุญุฏูุซุงุช ุงูุฌุฏูุฏุฉ:\n');
        
        const options = {
            hostname: 'api.github.com',
            port: 443,
            path: '/repos/elzaeem2/youssef-personal-website/commits?per_page=1',
            method: 'GET',
            headers: {
                'User-Agent': 'CMS-Update-Test'
            }
        };

        const req = https.request(options, (res) => {
            let data = '';
            
            res.on('data', (chunk) => {
                data += chunk;
            });
            
            res.on('end', () => {
                try {
                    const commits = JSON.parse(data);
                    if (commits.length > 0) {
                        const lastCommit = commits[0];
                        const date = new Date(lastCommit.commit.author.date);
                        const message = lastCommit.commit.message;
                        const sha = lastCommit.sha.substring(0, 7);
                        
                        console.log(`   ๐ ุขุฎุฑ commit:`);
                        console.log(`      SHA: ${sha}`);
                        console.log(`      ุงูุชุงุฑูุฎ: ${date.toLocaleString('ar-EG')}`);
                        console.log(`      ุงูุฑุณุงูุฉ: ${message.split('\n')[0]}`);
                        console.log(`      ุงููุคูู: ${lastCommit.commit.author.name}`);
                        
                        // Check if this is a CMS commit
                        const isCMSCommit = message.toLowerCase().includes('cms') || 
                                          message.toLowerCase().includes('update') ||
                                          message.toLowerCase().includes('create') ||
                                          message.toLowerCase().includes('delete');
                        
                        console.log(`      ูู CMS: ${isCMSCommit ? 'โ ูุญุชูู' : 'โ ุบูุฑ ูุญุชูู'}`);
                        
                        resolve({
                            success: true,
                            commit: lastCommit,
                            isCMS: isCMSCommit
                        });
                    } else {
                        console.log('   โ ูุง ุชูุฌุฏ commits');
                        resolve({ success: false });
                    }
                } catch (error) {
                    console.log(`   โ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช: ${error.message}`);
                    resolve({ success: false });
                }
            });
        });

        req.on('error', (e) => {
            console.log(`   โ ุฎุทุฃ ูู ุงูุงุชุตุงู: ${e.message}`);
            resolve({ success: false });
        });

        req.end();
    });
}

// Check Netlify deploy status
function checkNetlifyDeploys() {
    return new Promise((resolve) => {
        console.log('\n๐ ูุญุต ุญุงูุฉ ุงููุดุฑ ูู Netlify:\n');
        
        // Since we can't access Netlify API directly, we'll check the site
        const options = {
            hostname: 'youssef-personal-website.netlify.app',
            port: 443,
            path: '/',
            method: 'HEAD'
        };

        const req = https.request(options, (res) => {
            console.log(`   ุญุงูุฉ ุงููููุน: ${res.statusCode === 200 ? 'โ ูุชุงุญ' : 'โ ุบูุฑ ูุชุงุญ'}`);
            console.log(`   ุขุฎุฑ ุชุนุฏูู: ${res.headers['last-modified'] || 'ุบูุฑ ูุญุฏุฏ'}`);
            console.log(`   ETag: ${res.headers['etag'] || 'ุบูุฑ ูุญุฏุฏ'}`);
            console.log(`   Cache Control: ${res.headers['cache-control'] || 'ุบูุฑ ูุญุฏุฏ'}`);
            
            // Check for Netlify-specific headers
            const netlifyHeaders = Object.keys(res.headers).filter(h => h.startsWith('x-nf-'));
            if (netlifyHeaders.length > 0) {
                console.log(`   ุฑุคูุณ Netlify: ${netlifyHeaders.length} headers`);
                netlifyHeaders.forEach(header => {
                    console.log(`      ${header}: ${res.headers[header]}`);
                });
            }
            
            resolve(res.statusCode === 200);
        });

        req.on('error', (e) => {
            console.log(`   โ ุฎุทุฃ: ${e.message}`);
            resolve(false);
        });

        req.end();
    });
}

// Provide step-by-step testing instructions
function provideTestingInstructions(testData) {
    console.log('\n๐ ุชุนูููุงุช ุงูุงุฎุชุจุงุฑ ุฎุทูุฉ ุจุฎุทูุฉ:\n');
    
    console.log('   ๐ฏ ุงููุฏู: ุงุฎุชุจุงุฑ ุชุญุฏูุซ ุจุณูุท ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ');
    console.log('   โฑ๏ธ ุงูููุช ุงููุชููุน: 5-10 ุฏูุงุฆู\n');
    
    console.log('   ๐ ุงูุฎุทูุงุช:');
    console.log('   1. ุงุฐูุจ ุฅูู: https://youssef-personal-website.netlify.app/admin');
    console.log('   2. ุณุฌู ุฏุฎููู ุจู Netlify Identity');
    console.log('   3. ุงุจุญุซ ุนู ูุณู "๐งช ุงุฎุชุจุงุฑ ุงููุธุงู"');
    console.log(`   4. ุบูุฑ ุฑูู ุงููุงุชู ูู "${testData?.phone || '123-456-7890'}" ุฅูู "987-654-3210"`);
    console.log(`   5. ุบูุฑ ุฑูู ุงูุงุฎุชุจุงุฑ ูู "${testData?.test_number || '123'}" ุฅูู ุฑูู ุขุฎุฑ`);
    console.log('   6. ุงุถุบุท "ุญูุธ" ุฃู "ูุดุฑ"');
    console.log('   7. ุงูุชุธุฑ 2-3 ุฏูุงุฆู');
    console.log('   8. ุชุญูู ูู GitHub: https://github.com/elzaeem2/youssef-personal-website/commits');
    console.log('   9. ุชุญูู ูู ููู content/settings/test.yml ูู ุงููููุน');
    console.log('   10. ุฅุฐุง ุธูุฑ commit ุฌุฏูุฏุ ูุงููุธุงู ูุนูู! โ\n');
    
    console.log('   ๐ ุนูุงูุงุช ุงููุฌุงุญ:');
    console.log('   โข ุธููุฑ commit ุฌุฏูุฏ ูู GitHub ุฎูุงู 1-2 ุฏูููุฉ');
    console.log('   โข ุฑุณุงูุฉ ุงูู commit ุชุญุชูู ุนูู "Update" ุฃู ุงุณู ุงูููู');
    console.log('   โข ุชุญุฏูุซ ููู content/settings/test.yml ุจุงูููู ุงูุฌุฏูุฏุฉ');
    console.log('   โข ุนุฏู ุธููุฑ ุฃุฎุทุงุก ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ\n');
    
    console.log('   ๐จ ุฅุฐุง ูู ูุธูุฑ commit ุฌุฏูุฏ:');
    console.log('   โข ุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ');
    console.log('   โข ุชุฃูุฏ ูู ุธููุฑ ุฑุณุงูุฉ "ุชู ุงูุญูุธ ุจูุฌุงุญ"');
    console.log('   โข ุฑุงุฌุน ุณุฌู ุงููุดุฑ ูู Netlify ููุฃุฎุทุงุก');
    console.log('   โข ุฌุฑุจ ูุณุญ cache ุงููุชุตูุญ');
}

// Main test function
async function runCMSUpdateTest() {
    console.log('๐ ุจุฏุก ุงุฎุชุจุงุฑ ุชุญุฏูุซ CMS\n');
    
    // Step 1: Create test content
    const testData = createTestUpdate();
    
    if (!testData) {
        console.log('โ ูุดู ูู ุฅูุดุงุก ูุญุชูู ุงูุงุฎุชุจุงุฑ');
        return;
    }
    
    // Step 2: Add test collection to CMS config
    const configUpdated = addTestCollectionToConfig();
    
    if (!configUpdated) {
        console.log('โ ูุดู ูู ุชุญุฏูุซ ุฅุนุฏุงุฏุงุช CMS');
        return;
    }
    
    // Step 3: Monitor current state
    const githubStatus = await monitorGitHubCommits();
    const netlifyStatus = await checkNetlifyDeploys();
    
    // Step 4: Provide testing instructions
    provideTestingInstructions(testData);
    
    console.log('\n๐ฏ ููุฎุต ุงูุญุงูุฉ ุงูุญุงููุฉ:');
    console.log(`   GitHub: ${githubStatus.success ? 'โ ูุชุตู' : 'โ ุบูุฑ ูุชุตู'}`);
    console.log(`   Netlify: ${netlifyStatus ? 'โ ูุนูู' : 'โ ูุง ูุนูู'}`);
    console.log(`   ููู ุงูุงุฎุชุจุงุฑ: โ ุชู ุฅูุดุงุคู`);
    console.log(`   ุฅุนุฏุงุฏุงุช CMS: โ ุชู ุชุญุฏูุซูุง`);
    
    console.log('\n๐ ุฌุงูุฒ ููุงุฎุชุจุงุฑ!');
    console.log('ุงุชุจุน ุงูุชุนูููุงุช ุฃุนูุงู ูุงุฎุชุจุงุฑ ุงููุธุงู');
}

runCMSUpdateTest();
